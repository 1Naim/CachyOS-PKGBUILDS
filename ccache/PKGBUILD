# Maintainer: Levente Polyak <anthraxx[at]archlinux[dot]org>
# Contributor: Giovanni Scafora <giovanni@archlinux.org>
# Contributor: Tom Newsom <Jeepster@gmx.co.uk>

pkgname=ccache
pkgver=4.7.2
pkgrel=2
pkgdesc='Compiler cache that speeds up recompilation by caching previous compilations'
url='https://ccache.dev/'
arch=('x86_64')
license=('GPL3')
depends=('glibc' 'gcc-libs' 'hiredis' 'zstd' 'libzstd.so')
makedepends=('cmake' 'asciidoctor' 'perl')
source=(https://github.com/ccache/ccache/releases/download/v${pkgver}/ccache-${pkgver}.tar.xz{,.asc}
		"fix-kernel-cache.patch")
validpgpkeys=('5A939A71A46792CF57866A51996DDA075594ADB8') # Joel Rosdahl <joel@rosdahl.net>
sha512sums=('854834d38ae64c1a253746be7f30b6f6f50215277a3eb01f25dcab23d3fe1131bc5fde76da10506b72c8eca5b00bc63555f5c2363b8613833f491d05635173ed'
            'SKIP'
            '79b0f10b213903a5a4a78fcec07d39a9e15534d8ec4fac2ac96f804f5908cfde1300baaf87f965dbc3f8eab1ec1c75591f22b62627653feb48ab41b152daa546')
b2sums=('ce68e759bbeb99e5d5fb7341c85e58dbcf05aa21caa7aea67cba244041a44cfb22bceb7dcea47597ea44f39e88d7d006fd0a5fc7ceefb264309a74affedf8d8e'
        'SKIP'
        'ca535968a818bcb994a2f56ca9f081b1040a8eec77eb7be62cd4e8865e02a359da712984c087587d9b387ccb98abadebbd4ceb276f7db43c2f3571dbfa39d1c1')

prepare() {
	cd ${pkgname}-${pkgver}
	patch -Np1 < ../fix-kernel-cache.patch
}

build() {
  cd ${pkgname}-${pkgver}
  cmake \
    -DCMAKE_INSTALL_PREFIX=/usr \
    -DCMAKE_BUILD_TYPE=None \
    -Wno-dev \
    -B build \
    -S .
  make VERBOSE=1 -C build
}

check() {
  cd ${pkgname}-${pkgver}
  make VERBOSE=1 check -C build
}

package() {
  cd ${pkgname}-${pkgver}

  make DESTDIR="${pkgdir}" install -C build
  make DESTDIR="${pkgdir}" install -C build/doc

  install -Dm 644 doc/*.md doc/*.adoc -t "${pkgdir}/usr/share/doc/${pkgname}"

  install -d "${pkgdir}/usr/lib/ccache/bin"
  local _prog
  for _prog in gcc g++ c++; do
    ln -s /usr/bin/ccache "${pkgdir}/usr/lib/ccache/bin/$_prog"
    ln -s /usr/bin/ccache "${pkgdir}/usr/lib/ccache/bin/${CHOST}-$_prog"
  done
  for _prog in cc clang clang++; do
    ln -s /usr/bin/ccache "${pkgdir}/usr/lib/ccache/bin/$_prog"
  done
}

# vim: ts=2 sw=2 et:
