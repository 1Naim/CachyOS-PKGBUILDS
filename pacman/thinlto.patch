From 0e181483b7974d7876f01892f6e32aaaae1e6ecb Mon Sep 17 00:00:00 2001
From: Peter Jung <admin@ptr1337.dev>
Date: Tue, 11 Oct 2022 19:06:09 +0200
Subject: [PATCH] thinlto

---
 scripts/libmakepkg/buildenv/lto.sh.in | 15 +++++++++++++--
 1 file changed, 13 insertions(+), 2 deletions(-)

diff --git a/scripts/libmakepkg/buildenv/lto.sh.in b/scripts/libmakepkg/buildenv/lto.sh.in
index 6492def7..5feda992 100644
--- a/scripts/libmakepkg/buildenv/lto.sh.in
+++ b/scripts/libmakepkg/buildenv/lto.sh.in
@@ -26,8 +26,8 @@ LIBRARY=${LIBRARY:-'@libmakepkgdir@'}
 
 source "$LIBRARY/util/option.sh"
 
-build_options+=('lto')
-buildenv_functions+=('buildenv_lto')
+build_options+=('lto' 'thinlto')
+buildenv_functions+=('buildenv_lto' 'buildenv_thinlto')
 
 buildenv_lto() {
 	if check_option "lto" "y" && ! check_option "buildflags" "n"; then
@@ -36,3 +36,14 @@ buildenv_lto() {
 		LDFLAGS+=" ${LTOFLAGS:--flto}"
 	fi
 }
+
+buildenv_thinlto() {
+	if check_option "thinlto" "y" && ! check_option "buildflags" "n"; then
+		export CC=clang
+		export CXX=clang++
+		LDFLAGS+=",-fuse-ld=lld"
+		CFLAGS+=" ${LTOFLAGS:--flto=thin}"
+		CXXFLAGS+=" ${LTOFLAGS:--flto=thin}"
+		LDFLAGS+=" ${LTOFLAGS:--flto=thin}"
+	fi
+}
-- 
2.38.0

