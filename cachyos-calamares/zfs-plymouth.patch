From 8d0fe27461b423cac2659e31aa894f31082ae824 Mon Sep 17 00:00:00 2001
From: Vladislav Nepogodin <nepogodin.vlad@gmail.com>
Date: Tue, 2 Apr 2024 01:34:29 +0400
Subject: [PATCH] =?UTF-8?q?=F0=9F=9A=A7=20disable=20plymouth=20on=20zfs+en?=
 =?UTF-8?q?cryption?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

---
 src/modules/bootloader/main.py  | 10 ++++++++--
 src/modules/initcpiocfg/main.py |  6 ++++++
 src/modules/plymouthcfg/main.py |  7 +++++++
 src/modules/zfs/ZfsJob.cpp      |  3 +++
 4 files changed, 24 insertions(+), 2 deletions(-)

diff --git a/src/modules/bootloader/main.py b/src/modules/bootloader/main.py
index 0eb7dab47..812b13f07 100644
--- a/src/modules/bootloader/main.py
+++ b/src/modules/bootloader/main.py
@@ -130,6 +130,7 @@ def get_kernel_params(uuid):
     kernel_params.append("rw")
 
     partitions = libcalamares.globalstorage.value("partitions")
+    is_zfs_native_encrypted = libcalamares.globalstorage.value("zfsEncrypted")
     swap_uuid = ""
     swap_outer_mappername = None
     swap_outer_uuid = None
@@ -183,6 +184,11 @@ def get_kernel_params(uuid):
                 libcalamares.utils.warning("Internal error handling zfs dataset")
                 raise Exception("Internal zfs data missing, please contact your distribution")
 
+        if is_zfs_root(partition) and (is_zfs_native_encrypted or cryptdevice_params):
+            libcalamares.utils.debug("Disabling quite and splash on zfs+encryption..")
+            kernel_params.remove("quiet")
+            kernel_params.remove("splash")
+
     if cryptdevice_params:
         kernel_params.extend(cryptdevice_params)
     else:
@@ -243,10 +249,10 @@ def create_loader(loader_path, installation_root_path):
     :param loader_path: The absolute path to the loader.conf file
     :param installation_root_path: The path to the root of the target installation
     """
-    
+
     """
      Obsolete since default was changed to @saved from machine-id
-     
+
      get the machine-id
      with open(os.path.join(installation_root_path, "etc", "machine-id"), 'r') as machineid_file:
         machine_id = machineid_file.read().rstrip('\n')
diff --git a/src/modules/initcpiocfg/main.py b/src/modules/initcpiocfg/main.py
index 13a281bb3..d145ba017 100644
--- a/src/modules/initcpiocfg/main.py
+++ b/src/modules/initcpiocfg/main.py
@@ -156,6 +156,7 @@ def find_initcpio_features(partitions, root_mount_point):
     ]
 
     systemd_hook_allowed = libcalamares.job.configuration.get("useSystemdHook", False)
+    is_zfs_native_encrypted = libcalamares.globalstorage.value("zfsEncrypted")
 
     use_systemd = systemd_hook_allowed and target_env_call(["sh", "-c", "which systemd-cat"]) == 0
 
@@ -240,6 +241,11 @@ def find_initcpio_features(partitions, root_mount_point):
     else:
         hooks.append("fsck")
 
+    # remove plymouth hook for zfs with encryption
+    if uses_zfs and (is_zfs_native_encrypted or encrypt_hook):
+        libcalamares.utils.debug("removing plymouth from initramfs")
+        hooks.remove("plymouth")
+
     return hooks, modules, files, binaries
 
 
diff --git a/src/modules/plymouthcfg/main.py b/src/modules/plymouthcfg/main.py
index 259fee932..a480e687a 100644
--- a/src/modules/plymouthcfg/main.py
+++ b/src/modules/plymouthcfg/main.py
@@ -12,6 +12,7 @@
 #   Calamares is Free Software: see the License-Identifier above.
 #
 
+#import subprocess
 import libcalamares
 
 from libcalamares.utils import debug, target_env_call
@@ -51,7 +52,13 @@ def setTheme(self):
         target_env_call(["plymouth-set-default-theme", plymouth_theme])
 
     def run(self):
+        # TODO(vnepogodin): we might want to skip that on zfs+encryption, but only if we have encryption enabled.
+        #curr_filesystem = subprocess.run(["findmnt", "-ln", "-o", "FSTYPE", self.root], stdout=subprocess.PIPE).stdout.decode('utf-8')
+        #is_root_on_zfs = (curr_filesystem == "zfs\n")
+
+        #if detect_plymouth() and not is_root_on_zfs:
         if detect_plymouth():
+            #libcalamares.utils.debug("Running plymouth on {!s}".format(curr_filesystem))
             if (("plymouth_theme" in libcalamares.job.configuration) and
                (libcalamares.job.configuration["plymouth_theme"] is not None)):
                 self.setTheme()
diff --git a/src/modules/zfs/ZfsJob.cpp b/src/modules/zfs/ZfsJob.cpp
index 7181656e6..cea77981c 100644
--- a/src/modules/zfs/ZfsJob.cpp
+++ b/src/modules/zfs/ZfsJob.cpp
@@ -248,6 +248,9 @@ ZfsJob::exec()
             cWarning() << "Failed to create /etc/hostid";
         }
 
+        // Put information about native ZFS encryption into GS
+        gs->insert( "zfsEncrypted", encrypt );
+
         // Create the zpool
         ZfsResult zfsResult;
         if ( encrypt )
