From b7452d12d056491bdbe2db40ba20a336176a64fb Mon Sep 17 00:00:00 2001
From: Peter Jung <admin@ptr1337.dev>
Date: Mon, 19 Dec 2022 14:53:21 +0100
Subject: [PATCH] Add pybench to the PROFILE_TASK rule

This is necesary due to the fact that pybench is the main benchmark that
industry use to compare python performance. Openbenchmarking used it
so we need it as a base of PGO optimizations
---
 Makefile.pre.in | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/Makefile.pre.in b/Makefile.pre.in
index 51c31b94ae..14880a23d8 100644
--- a/Makefile.pre.in
+++ b/Makefile.pre.in
@@ -275,6 +275,7 @@ TCLTK_LIBS=	@TCLTK_LIBS@
 # by default. The default is "-m test --pgo". To run more tests, use
 # PROFILE_TASK="-m test --pgo-extended"
 PROFILE_TASK=	@PROFILE_TASK@
+PROFILE_TASK_PYBENCH= $(srcdir)/Tools/pybench/pybench.py -n 2 --with-gc --with-syscheck
 
 # report files for gcov / lcov coverage report
 COVERAGE_INFO=	$(abs_builddir)/coverage.info
@@ -521,6 +522,7 @@ build_all_generate_profile:
 run_profile_task:
 	@ # FIXME: can't run for a cross build
 	$(LLVM_PROF_FILE) $(RUNSHARED) ./$(BUILDPYTHON) $(PROFILE_TASK) || true
+	$(LLVM_PROF_FILE) $(RUNSHARED) ./$(BUILDPYTHON) $(PROFILE_TASK_PYBENCH) || true
 
 build_all_merge_profile:
 	$(LLVM_PROF_MERGER)
-- 
2.39.0

